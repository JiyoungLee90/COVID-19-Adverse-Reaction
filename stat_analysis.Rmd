---
title: Statistical Analysis of Risk Factors for Mortality in Patients with Post-COVID-19 Vaccination Adverse Reactions (Symptoms)
output: html_notebook
---
## 1. Data Prepration 
### 1.1 Load the data 
```{r}
setwd("~/covid-adv")
covid_adv <-read.csv("./covid_adv.csv")

print(head(covid_adv, n = 5))
```

### 1.2 Transform the data

#### Label Encoding 
```{r}
df <- covid_adv
df[['SEX']] <-ifelse(df[['SEX']] == 'F', 1, 0)
df[['DIED']] <- ifelse(df[['DIED']] == 'Yes', 1, 0)
symptom_cols <- colnames(covid_adv)
cols_to_remove <-c('VAERS_ID', 'AGE_YRS', 'DIED',
                    'AGE_GRP','SEX', 'VAX_MANU')
cols <- symptom_cols [! symptom_cols %in% cols_to_remove]

for (c in cols){
  df[[c]] <- ifelse(df[[c]] =='Yes', 1, 0)
}
```
```{r}
# set VAX_MANU as factor variable
df$VAX_MANU <-factor(df$VAX_MANU)
```

## 2. Statistical Analysis

### 2.1 Chi-Squared Test
Chi-squared test was used to assess if there is an **association** between

+ patient's demographic factor (age group, gender)
+ having a particular adverse reaction symptom
+ other factor (e.g, manufacturer of vaccination, hospital admission status)

and mortality. 

```{r, fig.width = 5, fig.height = 5}

library(MASS)
library(ggplot2)
chi_func <-function(col_name){
  c_table <-table(df$DIED, col_name)
  c_test <-chisq.test(c_table)
  return(c_test$p.value)
}

#cols to test
test_cols <- colnames(df)
cols_to_remove <-c('VAERS_ID', 'AGE_YRS', 'DIED')
test_cols <- test_cols [! test_cols %in% cols_to_remove]

#loop for applying chi-squared test
p_values <- c() 
for(i in 1:length(test_cols)){
  test_col <- test_cols[i]
  p <- chi_func(df[[test_col]])
  p_values <- append(p_values, p)
}

# data frame for p-value and corresponding variable
chisq_test_result <- data.frame(test_cols, p_values)
colnames(chisq_test_result) <- c('Variable', 'p_values')

# sort out variables that are associated with mortality with p < 0.05
significant <-c()
for(j in chisq_test_result[['p_values']]){
  if(j <0.05){
    significant <-append(significant, 'Yes')
  }else{
    significant <-append(significant, 'No')
  }
}
chisq_test_result$Significant <- significant

# -log(p-value)
log_10 <- c()
for(p in chisq_test_result[['p_values']]){
  l <- -log10(p)
  log_10 <- append(log_10, l)
}

chisq_test_result$LogP_value <- log_10

print(head(chisq_test_result, n = 5))


# chi-squared test results visualisation
ggplot(data = chisq_test_result, aes(x = reorder(Variable, LogP_value), y = LogP_value )) + geom_bar(stat = 'Identity', fill = 'steelblue') + coord_flip() + labs(title = 'Chi-squared test results', y = " -Log10 p-value", x = "Features") + geom_hline(yintercept = -log10(0.05),color = 'gold1', size = 0.5) + coord_flip(ylim=c(0, 10)) 
```

### 2.2 Logistic Regression Analysis
Logistic regression analyses were performed to assess the respective independent effects of symptoms and other factors on mortality after adjusting for age and gender.

```{r}
# variables for analysis
features <- colnames(df)
feature_to_remove <- c('VAERS_ID', 'AGE_YRS', 'AGE_GRP', 'DIED', 'SEX', 'VAX_MANU')
features <- features [! features %in% feature_to_remove]

OR <- c()
P <-c()
CI_low <- c()
CI_high <- c()
for(f in seq_along(features)){
  vars <-as.formula(sprintf("DIED ~ AGE_YRS + SEX + %s", features[f]))
  logit <-glm(formula = vars, family = binomial, data = df)
  or <- coef(logit)[4] # coefficient
  OR <- append(OR, exp(or)) # odd ratio
  P <- append(P, coef(summary(logit))[, 'Pr(>|z|)'][4])
  conf <- confint(logit)
  conf_low <- conf[4,1] # low CI
  conf_high <- conf[4,2] # high CI
  CI_low <- append(CI_low, exp(conf_low))
  CI_high<- append(CI_high, exp(conf_high))
}
logit_uni <- data.frame(OR, CI_low, CI_high, P)
colnames(logit_uni) <- c('OR','CI_2.5', 'CI_97.5', 'P_value')

```
```{r}
# vaccine manufacturer
vac_m <- glm(DIED ~ AGE_YRS + SEX + VAX_MANU, family = binomial,
             data = df)
or <- exp(coef(vac_m)[4]) # coefficient
p  <- coef(summary(vac_m))[, 'Pr(>|z|)'][4]
conf <- confint(vac_m)
conf_low <- exp(conf[4,1]) # low CI
conf_high <- exp(conf[4,2]) # high CI

MODERNA <- data.frame(or, conf_low, conf_high, p, 'VAX_MANUMODERNA')
names(MODERNA) <-colnames(logit_uni)
logit_uni <- rbind(logit_uni, MODERNA)

or <- exp(coef(vac_m)[5]) # coefficient
p  <- coef(summary(vac_m))[, 'Pr(>|z|)'][5]
conf <- confint(vac_m)
conf_low <- exp(conf[5,1])# low CI
conf_high <- exp(conf[5,2]) # high CI

PFIZER <- data.frame(or, conf_low, conf_high, p, 'VAX_MANUPFIZER\\BIONTECH ')
names(PFIZER) <-colnames(logit_uni)
logit_uni <- rbind(logit_uni, PFIZER)

```
```{r fig.width = 5, fig.height = 5}
write.csv(logit_uni, 'logit_results_uni.csv')

# visualisation of logistic regression results
logit_uni['Symptom'] <- rownames(logit_uni)
boxLables <- rownames(logit_uni)

ggplot(logit_uni, aes(x = OR, y = length(logit_uni$Symptom):1)) + 
  geom_vline(aes(xintercept = 1), size = .40, linetype = 'dashed',
             color = 'red') + 
  geom_errorbarh(aes(xmax = CI_97.5, xmin = CI_2.5), size = .5,
                 height = .2, color = 'gray50') +
  geom_point(size = 2.5, color = 'orange') +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  scale_y_continuous(breaks = length(logit_uni$Symptom):1, 
                     labels = logit_uni$Symptom) +
  scale_x_continuous(breaks = seq(0, 3, 0.5)) +
  ylab("") + xlab("Odds Ratio")

```

